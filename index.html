<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>匿名聊 - 自由聊天空間</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            transition: background 0.5s ease;
        }
        
        .bg-space {
            background-color: #000000;
            background-image: radial-gradient(rgba(255, 255, 255, 0.8) 1px, transparent 0),
                             radial-gradient(rgba(255, 255, 255, 0.4) 1px, transparent 0);
            background-size: 50px 50px, 30px 30px;
            background-position: 0 0, 25px 25px;
            background-attachment: fixed;
        }
        
        .bg-geometric {
            background-color: #4158D0;
            background-image: linear-gradient(43deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%);
            background-attachment: fixed;
        }
        
        .bg-tech {
            background-color: #0f172a;
            background-image: 
                linear-gradient(rgba(59, 130, 246, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.2) 1px, transparent 1px);
            background-size: 30px 30px;
            position: relative;
            overflow: hidden;
        }
        
        .tech-circuit {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(59, 130, 246, 0.3) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(59, 130, 246, 0.3) 1px, transparent 1px);
            background-size: 60px 60px;
            z-index: 1;
        }
        
        .bg-nature {
            background: linear-gradient(to bottom, #2e7d32, #1b5e20);
            position: relative;
            overflow: hidden;
        }
        
        .nature-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath fill='%23ffffff' fill-opacity='0.1' d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z'%3E%3C/path%3E%3C/svg%3E");
            z-index: 1;
        }
        
        .bg-neon {
            background-color: #0f0f1a;
            position: relative;
            overflow: hidden;
        }
        
        .neon-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 0, 255, 0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.2) 1px, transparent 1px);
            background-size: 40px 40px;
            perspective: 1000px;
            transform-style: preserve-3d;
            transform: rotateX(60deg);
            z-index: 1;
        }
        
        .neon-glow {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: radial-gradient(circle at 50% 50%, rgba(255, 0, 255, 0.3) 0%, rgba(0, 255, 255, 0.3) 50%, transparent 100%);
            z-index: 2;
        }
        
        .chat-container {
            height: calc(100vh - 180px);
        }
        
        .message {
            max-width: 80%;
            word-break: break-word;
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-user {
            background-color: #3b82f6;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .message-other {
            background-color: #e5e7eb;
            color: #1f2937;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .settings-panel {
            position: fixed;
            top: 0;
            right: -320px;
            width: 320px;
            height: 100vh;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .settings-panel.open {
            right: 0;
        }
        
        .bg-option {
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .bg-option:hover {
            transform: scale(1.05);
        }
        
        .bg-option.active {
            border: 3px solid #3b82f6;
        }
        
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 4s infinite;
        }
        
        @keyframes twinkle {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }
        
        .welcome-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.5s ease;
        }
        
        .welcome-content {
            max-width: 90%;
            width: 450px;
            animation: scaleIn 0.3s ease;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .rule-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .rule-number {
            background-color: rgba(255, 255, 255, 0.2);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .char-counter {
            font-size: 12px;
            text-align: right;
            margin-top: 4px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .char-counter.limit {
            color: #ef4444;
        }
        
        .alert-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadeIn 0.3s ease;
        }
        
        .alert-content {
            max-width: 90%;
            width: 350px;
            animation: scaleIn 0.3s ease;
        }
        
        .alert-icon {
            width: 50px;
            height: 50px;
            background-color: #fef2f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }
        
        .alert-icon svg {
            color: #ef4444;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.5s ease;
        }
        
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .cooldown-container {
            position: relative;
            height: 4px;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
            display: none;
        }
        
        .cooldown-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
            background-size: 200% 100%;
            animation: gradientMove 2s linear infinite;
            transform-origin: left;
        }
        
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-600 to-blue-500 min-h-screen">
    <!-- 歡迎提示框 -->
    <div id="welcome-modal" class="welcome-modal">
        <div class="welcome-content glass-panel p-6">
            <h2 class="text-2xl font-bold text-white text-center mb-4">歡迎使用匿名聊</h2>
            <p class="text-white text-center mb-6">請遵守以下規則</p>
            
            <div class="space-y-4 mb-6">
                <div class="rule-item">
                    <div class="rule-number">
                        <span class="text-white text-sm">1</span>
                    </div>
                    <p class="text-white">禁止在聊天室打廣告或者發布暴力、血腥、色情內容</p>
                </div>
                
                <div class="rule-item">
                    <div class="rule-number">
                        <span class="text-white text-sm">2</span>
                    </div>
                    <p class="text-white">請勿在聊天室內洗版</p>
                </div>
                
                <div class="rule-item">
                    <div class="rule-number">
                        <span class="text-white text-sm">3</span>
                    </div>
                    <p class="text-white">聊得開心</p>
                </div>
            </div>
            
            <button id="agree-btn" class="w-full bg-white text-purple-600 font-bold py-3 px-6 rounded-lg hover:bg-opacity-90 transition-all">
                我同意
            </button>
        </div>
    </div>

    <!-- 警告通知 -->
    <div id="alert-modal" class="alert-modal hidden">
        <div class="alert-content glass-panel p-6">
            <div class="alert-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-xl font-bold text-white text-center mb-2">警告</h3>
            <p id="alert-message" class="text-white text-center mb-6">請檢查輸入內容</p>
            <button id="alert-close-btn" class="w-full bg-white text-purple-600 font-bold py-2 px-6 rounded-lg hover:bg-opacity-90 transition-all">
                我知道了
            </button>
        </div>
    </div>

    <!-- 暱稱選擇畫面 -->
    <div id="nickname-screen" class="flex items-center justify-center min-h-screen p-4 hidden">
        <div class="glass-panel p-8 w-full max-w-md text-center">
            <h1 class="text-3xl font-bold text-white mb-6">匿名聊</h1>
            <p class="text-white mb-6">選擇一個暱稱開始聊天</p>
            <input type="text" id="nickname-input" placeholder="輸入暱稱..." maxlength="30"
                class="w-full p-3 rounded-lg mb-2 bg-white/20 text-white placeholder-white/70 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50">
            <div id="nickname-counter" class="char-counter mb-4">0/30</div>
            <button id="start-chat-btn" 
                class="w-full bg-white text-purple-600 font-bold py-3 px-6 rounded-lg hover:bg-opacity-90 transition-all">
                開始聊天
            </button>
        </div>
    </div>

    <!-- 聊天介面 -->
    <div id="chat-screen" class="hidden flex flex-col h-screen">
        <!-- 頂部導航 -->
        <div class="flex justify-between items-center p-4 glass-panel m-2 rounded-lg">
            <div class="flex items-center">
                <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                <h1 class="text-xl font-bold text-white">匿名聊</h1>
            </div>
            <div class="flex items-center">
                <span id="user-nickname" class="text-white mr-3"></span>
                <button id="settings-btn" class="text-white hover:bg-white/20 p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- 聊天內容 -->
        <div class="flex-1 overflow-y-auto p-4 chat-container">
            <div id="messages" class="flex flex-col space-y-2">
                <div class="message message-other">
                    <span class="text-xs opacity-70">系統</span>
                    <div>歡迎來到匿名聊！開始與其他人聊天吧！</div>
                </div>
            </div>
        </div>

        <!-- 輸入框 -->
        <div class="p-4">
            <div class="glass-panel p-2 rounded-lg flex flex-col">
                <div class="flex">
                    <input type="text" id="message-input" placeholder="輸入訊息..." maxlength="1000"
                        class="flex-1 bg-transparent border-none text-white placeholder-white/70 focus:outline-none p-2">
                    <button id="send-btn" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-medium hover:bg-opacity-90">
                        發送
                    </button>
                </div>
                <div id="message-counter" class="char-counter px-2">0/1000</div>
                <div id="cooldown-container" class="cooldown-container">
                    <div id="cooldown-bar" class="cooldown-bar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 設定面板 -->
    <div id="settings-panel" class="settings-panel glass-panel p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-white">設定</h2>
            <button id="close-settings" class="text-white hover:bg-white/20 p-2 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <div class="mb-6">
            <h3 class="text-white text-lg mb-3">背景選擇</h3>
            <div class="grid grid-cols-1 gap-4">
                <div class="bg-option active p-2 rounded-lg" data-bg="default">
                    <div class="h-20 rounded bg-gradient-to-br from-purple-600 to-blue-500 flex items-center justify-center">
                        <span class="text-white font-medium">預設漸層</span>
                    </div>
                </div>
                <div class="bg-option p-2 rounded-lg" data-bg="space">
                    <div class="h-20 rounded bg-black flex items-center justify-center relative overflow-hidden">
                        <div class="star" style="width: 2px; height: 2px; top: 20%; left: 10%;"></div>
                        <div class="star" style="width: 1px; height: 1px; top: 30%; left: 20%; animation-delay: 1s;"></div>
                        <div class="star" style="width: 2px; height: 2px; top: 50%; left: 30%; animation-delay: 2s;"></div>
                        <div class="star" style="width: 1px; height: 1px; top: 70%; left: 40%; animation-delay: 0.5s;"></div>
                        <span class="text-white font-medium z-10">太空星空</span>
                    </div>
                </div>
                <div class="bg-option p-2 rounded-lg" data-bg="geometric">
                    <div class="h-20 rounded bg-geometric flex items-center justify-center">
                        <span class="text-white font-medium">幾何圖形</span>
                    </div>
                </div>
                <div class="bg-option p-2 rounded-lg" data-bg="tech">
                    <div class="h-20 rounded bg-tech flex items-center justify-center relative overflow-hidden">
                        <div class="tech-circuit"></div>
                        <span class="text-white font-medium z-10">科技風格</span>
                    </div>
                </div>
                <div class="bg-option p-2 rounded-lg" data-bg="nature">
                    <div class="h-20 rounded bg-nature flex items-center justify-center relative overflow-hidden">
                        <div class="nature-overlay"></div>
                        <span class="text-white font-medium z-10">森林自然</span>
                    </div>
                </div>
                <div class="bg-option p-2 rounded-lg" data-bg="neon">
                    <div class="h-20 rounded bg-neon flex items-center justify-center relative overflow-hidden">
                        <div class="neon-grid"></div>
                        <div class="neon-glow"></div>
                        <span class="text-white font-medium z-10">霓虹城市</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mb-6">
            <h3 class="text-white text-lg mb-3">更改暱稱</h3>
            <div class="flex flex-col">
                <div class="flex">
                    <input type="text" id="change-nickname" placeholder="新的暱稱" maxlength="30"
                        class="flex-1 p-2 rounded-l-lg bg-white/20 text-white placeholder-white/70 border border-white/30 focus:outline-none">
                    <button id="update-nickname" class="bg-white text-purple-600 px-4 py-2 rounded-r-lg font-medium hover:bg-opacity-90">
                        更新
                    </button>
                </div>
                <div id="change-nickname-counter" class="char-counter mt-1">0/30</div>
            </div>
        </div>
    </div>

    <!-- 星空背景的星星 -->
    <div id="stars-container" class="fixed inset-0 pointer-events-none hidden"></div>
    
    <!-- 科技風格背景元素 -->
    <div id="tech-container" class="fixed inset-0 pointer-events-none hidden">
        <div class="tech-circuit"></div>
    </div>
    
    <!-- 森林自然背景元素 -->
    <div id="nature-container" class="fixed inset-0 pointer-events-none hidden">
        <div class="nature-overlay"></div>
    </div>
    
    <!-- 霓虹城市背景元素 -->
    <div id="neon-container" class="fixed inset-0 pointer-events-none hidden">
        <div class="neon-grid"></div>
        <div class="neon-glow"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化 Socket.IO
            const socket = io('http://localhost:3000');

            // 元素
            const welcomeModal = document.getElementById('welcome-modal');
            const agreeBtn = document.getElementById('agree-btn');
            const nicknameScreen = document.getElementById('nickname-screen');
            const chatScreen = document.getElementById('chat-screen');
            const nicknameInput = document.getElementById('nickname-input');
            const nicknameCounter = document.getElementById('nickname-counter');
            const startChatBtn = document.getElementById('start-chat-btn');
            const userNickname = document.getElementById('user-nickname');
            const messageInput = document.getElementById('message-input');
            const messageCounter = document.getElementById('message-counter');
            const sendBtn = document.getElementById('send-btn');
            const messagesContainer = document.getElementById('messages');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsPanel = document.getElementById('settings-panel');
            const closeSettings = document.getElementById('close-settings');
            const bgOptions = document.querySelectorAll('.bg-option');
            const changeNicknameInput = document.getElementById('change-nickname');
            const changeNicknameCounter = document.getElementById('change-nickname-counter');
            const updateNicknameBtn = document.getElementById('update-nickname');
            const starsContainer = document.getElementById('stars-container');
            const techContainer = document.getElementById('tech-container');
            const natureContainer = document.getElementById('nature-container');
            const neonContainer = document.getElementById('neon-container');
            const alertModal = document.getElementById('alert-modal');
            const alertMessage = document.getElementById('alert-message');
            const alertCloseBtn = document.getElementById('alert-close-btn');
            const cooldownContainer = document.getElementById('cooldown-container');
            const cooldownBar = document.getElementById('cooldown-bar');

            // 用戶資料
            let userData = {
                nickname: '',
                background: 'default'
            };

            // 冷卻時間
            const cooldownTime = 3000; // 3秒冷卻時間
            let cooldownTimer = null;

            // 字數計數器
            function updateCharCounter(input, counter, maxLength) {
                const length = input.value.length;
                counter.textContent = `${length}/${maxLength}`;
                if (length >= maxLength) {
                    counter.classList.add('limit');
                } else {
                    counter.classList.remove('limit');
                }
            }

            // 暱稱輸入計數
            nicknameInput.addEventListener('input', function() {
                updateCharCounter(this, nicknameCounter, 30);
            });

            // 訊息輸入計數
            messageInput.addEventListener('input', function() {
                updateCharCounter(this, messageCounter, 1000);
            });

            // 更改暱稱輸入計數
            changeNicknameInput.addEventListener('input', function() {
                updateCharCounter(this, changeNicknameCounter, 30);
            });

            // 顯示警告通知
            function showAlert(message) {
                alertMessage.textContent = message;
                alertModal.classList.remove('hidden');
                alertModal.querySelector('.alert-content').classList.add('shake');
            }

            // 關閉警告通知
            alertCloseBtn.addEventListener('click', function() {
                alertModal.classList.add('hidden');
                alertModal.querySelector('.alert-content').classList.remove('shake');
            });

            // 開始冷卻倒數
            function startCooldown() {
                cooldownContainer.style.display = 'block';
                cooldownBar.style.animation = 'none';
                cooldownBar.style.width = '100%';
                cooldownBar.style.transition = `width ${cooldownTime / 1000}s linear`;
                cooldownBar.offsetHeight;
                cooldownBar.style.width = '0%';

                if (cooldownTimer) {
                    clearTimeout(cooldownTimer);
                }

                cooldownTimer = setTimeout(() => {
                    cooldownContainer.style.display = 'none';
                    sendBtn.disabled = false;
                    sendBtn.classList.remove('btn-disabled');
                }, cooldownTime);
            }

            // 添加訊息到聊天區
            function addMessage(sender, text, isUser = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'message-user' : 'message-other'}`;
                
                const senderSpan = document.createElement('span');
                senderSpan.className = 'text-xs opacity-70';
                senderSpan.textContent = sender;
                
                const textDiv = document.createElement('div');
                textDiv.textContent = text;
                
                messageDiv.appendChild(senderSpan);
                messageDiv.appendChild(textDiv);
                messagesContainer.appendChild(messageDiv);
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // 添加系統訊息
            function addSystemMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message message-other';
                
                const senderSpan = document.createElement('span');
                senderSpan.className = 'text-xs opacity-70';
                senderSpan.textContent = '系統';
                
                const textDiv = document.createElement('div');
                textDiv.textContent = text;
                
                messageDiv.appendChild(senderSpan);
                messageDiv.appendChild(textDiv);
                messagesContainer.appendChild(messageDiv);
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // 歡迎提示框
            agreeBtn.addEventListener('click', function() {
                welcomeModal.style.opacity = '0';
                welcomeModal.style.transition = 'opacity 0.3s ease';
                
                setTimeout(() => {
                    welcomeModal.style.display = 'none';
                    nicknameScreen.classList.remove('hidden');
                    nicknameInput.focus();
                    localStorage.setItem('anonymousChatAgreed', 'true');
                }, 300);
            });

            // 檢查是否已經同意過規則
            if (localStorage.getItem('anonymousChatAgreed') === 'true') {
                welcomeModal.style.display = 'none';
                nicknameScreen.classList.remove('hidden');
            }

            // 開始聊天
            startChatBtn.addEventListener('click', function() {
                const nickname = nicknameInput.value.trim();
                if (!nickname) {
                    showAlert('請輸入暱稱！');
                    return;
                }

                socket.emit('join', nickname, (response) => {
                    if (response.success) {
                        userData.nickname = nickname;
                        userNickname.textContent = nickname;
                        nicknameScreen.classList.add('hidden');
                        chatScreen.classList.remove('hidden');
                    } else {
                        showAlert(response.message);
                    }
                });
            });

            // 發送訊息
            function sendMessage() {
                const message = messageInput.value.trim();
                if (message) {
                    sendBtn.disabled = true;
                    sendBtn.classList.add('btn-disabled');
                    socket.emit('send-message', message, (response) => {
                        if (response.success) {
                            addMessage(userData.nickname, message, true);
                            messageInput.value = '';
                            updateCharCounter(messageInput, messageCounter, 1000);
                            startCooldown();
                        } else {
                            showAlert(response.message);
                            sendBtn.disabled = false;
                            sendBtn.classList.remove('btn-disabled');
                        }
                    });
                }
            }

            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // 接收聊天訊息
            socket.on('chat-message', ({ sender, text, isUser }) => {
                addMessage(sender, text, sender === userData.nickname);
            });

            // 接收系統訊息
            socket.on('system-message', (text) => {
                addSystemMessage(text);
            });

            // 設定面板
            settingsBtn.addEventListener('click', function() {
                settingsPanel.classList.add('open');
            });

            closeSettings.addEventListener('click', function() {
                settingsPanel.classList.remove('open');
            });

            // 創建星星背景
            function createStars() {
                starsContainer.innerHTML = '';
                starsContainer.classList.remove('hidden');
                const starCount = window.innerWidth < 768 ? 50 : 100;
                for (let i = 0; i < starCount; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    const size = Math.random() * 2 + 1;
                    star.style.width = `${size}px`;
                    star.style.height = `${size}px`;
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.animationDelay = `${Math.random() * 4}s`;
                    starsContainer.appendChild(star);
                }
            }

            // 隱藏所有背景容器
            function hideAllBackgroundContainers() {
                starsContainer.classList.add('hidden');
                techContainer.classList.add('hidden');
                natureContainer.classList.add('hidden');
                neonContainer.classList.add('hidden');
            }

            // 背景選擇
            bgOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const bg = this.getAttribute('data-bg');
                    bgOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    document.body.className = '';
                    hideAllBackgroundContainers();
                    if (bg === 'default') {
                        document.body.classList.add('bg-gradient-to-br', 'from-purple-600', 'to-blue-500');
                    } else if (bg === 'space') {
                        document.body.classList.add('bg-black');
                        createStars();
                    } else if (bg === 'tech') {
                        document.body.classList.add('bg-tech');
                        techContainer.classList.remove('hidden');
                    } else if (bg === 'nature') {
                        document.body.classList.add('bg-nature');
                        natureContainer.classList.remove('hidden');
                    } else if (bg === 'neon') {
                        document.body.classList.add('bg-neon');
                        neonContainer.classList.remove('hidden');
                    } else {
                        document.body.classList.add(`bg-${bg}`);
                    }
                    userData.background = bg;
                });
            });

            // 更新暱稱
            updateNicknameBtn.addEventListener('click', function() {
                const newNickname = changeNicknameInput.value.trim();
                if (newNickname) {
                    socket.emit('update-nickname', newNickname, (response) => {
                        if (response.success) {
                            userData.nickname = response.newNickname;
                            userNickname.textContent = response.newNickname;
                            changeNicknameInput.value = '';
                            updateCharCounter(changeNicknameInput, changeNicknameCounter, 30);
                            settingsPanel.classList.remove('open');
                        } else {
                            showAlert(response.message);
                        }
                    });
                }
            });

            // 初始化字數計數器
            updateCharCounter(nicknameInput, nicknameCounter, 30);
            updateCharCounter(messageInput, messageCounter, 1000);
            updateCharCounter(changeNicknameInput, changeNicknameCounter, 30);

            // 初始化
            if (localStorage.getItem('anonymousChatAgreed') === 'true') {
                nicknameInput.focus();
            }
        });
    </script>
</body>
</html>
